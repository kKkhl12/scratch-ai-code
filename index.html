<!DOCTYPE html>
<html>
<head>
    <title>AI Scratch Coder v0.1 (Corrected)</title>
    <!-- We need the JSZip library to create the .sb3 (zip) file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

    <h1>AI Scratch Coder - Step 1</h1>
    <p>Click the button to generate an .sb3 file with a single "forever" block attached to a "when green flag clicked" event.</p>
    <button id="generateBtn">Generate Scratch Project</button>

    <script>
        // Find the button in our HTML
        const generateBtn = document.getElementById('generateBtn');

        // Add an event listener to run our code when the button is clicked
        generateBtn.addEventListener('click', generateProject);

        function generateProject() {
            // --- 1. Define the Blocks ---
            const topBlockId = "event_whenflagclicked_1";
            const foreverBlockId = "control_forever_1";

            // --- 2. Create the project.json Structure ---
            const projectJson = {
                "targets": [
                    {
                        "isStage": true, "name": "Stage", "variables": {}, "lists": {}, "broadcasts": {}, "blocks": {}, "comments": {}, "currentCostume": 0,
                        "costumes": [ { "name": "backdrop1", "assetId": "cd21514d0531fdffb22204e0ec5ed84a", "md5ext": "cd21514d0531fdffb22204e0ec5ed84a.svg", "dataFormat": "svg", "rotationCenterX": 240, "rotationCenterY": 180 } ],
                        "sounds": [], "volume": 100, "layerOrder": 0, "tempo": 60, "videoTransparency": 50, "videoState": "on", "textToSpeechLanguage": null
                    },
                    {
                        "isStage": false, "name": "Sprite1", "variables": {}, "lists": {}, "broadcasts": {},
                        "blocks": {
                            [topBlockId]: {
                                "opcode": "event_whenflagclicked",
                                "next": foreverBlockId,
                                "parent": null,
                                "inputs": {}, "fields": {}, "shadow": false, "topLevel": true, "x": 100, "y": 100
                            },
                            [foreverBlockId]: {
                                "opcode": "control_forever",
                                "next": null,
                                "parent": topBlockId,
                                "inputs": {
                                    // *** THIS IS THE CORRECTED LINE ***
                                    // [2, ...] indicates a SUBSTACK (a stack of blocks).
                                    // null means the stack is empty.
                                    "SUBSTACK": [2, null] 
                                },
                                "fields": {}, "shadow": false, "topLevel": false
                            }
                        },
                        "comments": {}, "currentCostume": 0,
                        "costumes": [
                            { "name": "costume1", "assetId": "bcf454acf82e4504149f7ffe07081dbc", "md5ext": "bcf454acf82e4504149f7ffe07081dbc.svg", "dataFormat": "svg", "rotationCenterX": 48, "rotationCenterY": 50 },
                            { "name": "costume2", "assetId": "0fb9be3e8397c98333ecda8c7244ae6a", "md5ext": "0fb9be3e8397c98333ecda8c7244ae6a.svg", "dataFormat": "svg", "rotationCenterX": 46, "rotationCenterY": 53 }
                        ],
                        "sounds": [ { "name": "Meow", "assetId": "83c36d806dc92327b9e7049a565c6bff", "md5ext": "83c36d806dc92327b9e7049a565c6bff.mp3", "dataFormat": "mp3", "rate": 48000, "sampleCount": 40681 } ],
                        "volume": 100, "layerOrder": 1, "visible": true, "x": 0, "y": 0, "size": 100, "direction": 90, "draggable": false, "rotationStyle": "all around"
                    }
                ],
                "monitors": [], "extensions": [],
                "meta": { "semver": "3.0.0", "vm": "0.2.0-prerelease.20220712202534", "agent": "AI Coder v0.1" }
            };

            // --- 3. Create the .sb3 file using JSZip ---
            const zip = new JSZip();
            zip.file("project.json", JSON.stringify(projectJson));
            
            // --- 4. Generate and Download the file ---
            zip.generateAsync({ type: "blob" }).then(blob => {
                const a = document.createElement("a");
                document.body.appendChild(a);
                a.style = "display: none";
                const url = window.URL.createObjectURL(blob);
                a.href = url;
                a.download = "ai-project.sb3";
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }).catch(err => {
                alert("Error generating file: " + err.message);
            });
        }
    </script>

</body>
</html>
